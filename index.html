<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CampusChat - Enhanced with File Sharing</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0d6efd">

<!-- Favicon -->
<link rel="icon" type="image/png" sizes="32x32" href="icon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="icon-16x16.png">

<!-- Apple Touch Icon -->
<link rel="apple-touch-icon" href="icon-180x180.png">
    <style>
        :root {
            --dark-bg: #1a1a2e;
            --dark-card: #16213e;
            --dark-text: #e6e6e6;
            --light-bg: #f8f9fa;
            --light-card: #ffffff;
            --light-text: #212529;
            --primary: #0d6efd;
            --secondary: #6c757d;
        }
        
        body {
            background-color: var(--light-bg);
            color: var(--light-text);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: all 0.3s ease;
        }
        
        body.dark-theme {
            background-color: var(--dark-bg);
            color: var(--dark-text);
        }
        
        .card {
            background-color: var(--light-card);
            border: 1px solid #dee2e6;
            color: var(--light-text);
            transition: all 0.3s ease;
        }
        
        .dark-theme .card {
            background-color: var(--dark-card);
            border: 1px solid #2a2a4a;
            color: var(--dark-text);
        }
        
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            background-color: #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #6c757d;
        }
        
        .hidden {
            display: none !important;
        }
        
        .layout-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            padding: 1rem;
        }
        
        @media (min-width: 992px) {
            .layout-grid {
                grid-template-columns: 1fr 2fr 1fr;
            }
            
            .chats-layout {
                display: grid;
                grid-template-columns: 1fr 2fr;
                gap: 1rem;
            }
            
            .profile-layout {
                display: grid;
                grid-template-columns: 2fr 1fr;
                gap: 1rem;
            }
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--light-card);
            padding: 0.5rem;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            justify-content: space-around;
        }
        
        .dark-theme .bottom-nav {
            background-color: var(--dark-card);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .nav-btn {
            flex: 1;
            text-align: center;
            padding: 0.5rem;
            font-size: 0.8rem;
            cursor: pointer;
            color: var(--secondary);
            position: relative;
        }
        
        .nav-btn.active {
            color: var(--primary);
        }
        
        .dark-theme .nav-btn {
            color: #aaa;
        }
        
        .dark-theme .nav-btn.active {
            color: var(--primary);
        }
        
        .message {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            max-width: 80%;
        }
        
        .message.sent {
            background-color: #d1ecff;
            color: #000;
            margin-left: auto;
        }
        
        .dark-theme .message.sent {
            background-color: #0d3c61;
            color: #fff;
        }
        
        .message.received {
            background-color: #f1f0f0;
            color: #000;
        }
        
        .dark-theme .message.received {
            background-color: #2a2a4a;
            color: #fff;
        }
        
        .dropdown-list {
            position: absolute;
            background-color: var(--light-card);
            border: 1px solid #dee2e6;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            border-radius: 0.25rem;
        }
        
        .dark-theme .dropdown-list {
            background-color: var(--dark-card);
            border: 1px solid #2a2a4a;
        }
        
        .dropdown-item {
            padding: 0.5rem;
            cursor: pointer;
            border-bottom: 1px solid #dee2e6;
        }
        
        .dark-theme .dropdown-item {
            border-bottom: 1px solid #2a2a4a;
        }
        
        .dropdown-item:hover {
            background-color: #f8f9fa;
        }
        
        .dark-theme .dropdown-item:hover {
            background-color: #2a2a4a;
        }
        
        .typing-indicator {
            font-style: italic;
            color: var(--secondary);
            font-size: 0.9rem;
        }
        
        .post {
            border-bottom: 1px solid #dee2e6;
            padding: 1rem 0;
        }
        
        .dark-theme .post {
            border-bottom: 1px solid #2a2a4a;
        }
        
        .reaction-btn {
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            margin-right: 0.5rem;
            border: none;
            background: transparent;
            font-size: 1.2rem;
        }
        
        .reaction-btn:hover {
            background-color: #f8f9fa;
            transform: scale(1.1);
        }
        
        .dark-theme .reaction-btn:hover {
            background-color: #2a2a4a;
        }
        
        .reaction-btn.active {
            background-color: #e9ecef;
        }
        
        .dark-theme .reaction-btn.active {
            background-color: #3a3a5a;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .modal-content {
            width: 90%;
            max-width: 500px;
            padding: 1rem;
        }
        
        @media (max-width: 768px) {
            .layout-grid {
                padding-bottom: 60px;
            }
            
            .main {
                padding-bottom: 60px;
            }
        }
        
        .notification-item {
            padding: 0.75rem;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
        }
        
        .dark-theme .notification-item {
            border-bottom: 1px solid #2a2a4a;
        }
        
        .notification-item:last-child {
            border-bottom: none;
        }
        
        .notification-item.unread {
            background-color: rgba(13, 110, 253, 0.1);
        }
        
        .dark-theme .notification-item.unread {
            background-color: rgba(13, 110, 253, 0.2);
        }
        
        .edit-profile-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .edit-profile-modal.show {
            display: flex;
        }
        
        .edit-profile-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
        }
        
        .dark-theme .edit-profile-content {
            background-color: var(--dark-card);
        }
        
        .group-member {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid #dee2e6;
        }
        
        .dark-theme .group-member {
            border-bottom: 1px solid #2a2a4a;
        }
        
        .admin-badge {
            background-color: #0d6efd;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            margin-left: auto;
        }
        
        .console-log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            padding: 0.75rem;
            font-family: monospace;
            font-size: 0.875rem;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .dark-theme .console-log {
            background-color: #2a2a4a;
            border-color: #3a3a5a;
            color: #e6e6e6;
        }

        /* Notification badges */
        .notification-badge {
            position: absolute;
            top: 0;
            right: 20%;
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-btn .notification-badge {
            top: 5px;
            right: 25%;
        }

        .btn .notification-badge {
            position: relative;
            top: -2px;
            right: -5px;
        }

        /* Chat header styles */
        .chat-header {
            padding: 0.75rem;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .dark-theme .chat-header {
            border-bottom: 1px solid #2a2a4a;
        }
        
        /* File and voice message styles */
        .file-message, .voice-message {
            padding: 10px;
            border-radius: 8px;
            margin: 5px 0;
            display: flex;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .dark-theme .file-message, .dark-theme .voice-message {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .file-icon, .voice-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        
        .voice-player {
            flex-grow: 1;
            display: flex;
            align-items: center;
        }
        
        .voice-player progress {
            flex-grow: 1;
            margin-right: 10px;
            height: 8px;
        }
        
        /* Date separator */
        .date-separator {
            text-align: center;
            margin: 15px 0;
            position: relative;
        }
        
        .date-separator span {
            background-color: #e9ecef;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .dark-theme .date-separator span {
            background-color: #2a2a4a;
            color: #aaa;
        }
        
        /* Message time */
        .message-time {
            font-size: 0.7rem;
            text-align: right;
            color: #6c757d;
            margin-top: 3px;
        }
        
        .dark-theme .message-time {
            color: #aaa;
        }
        
        /* Post time */
        .post-time {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 3px;
        }
        
        .dark-theme .post-time {
            color: #aaa;
        }
        
        /* Message actions */
        .message-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        
        /* Recording animation */
        .recording-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background-color: #dc3545;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.4; }
            100% { opacity: 1; }
        }
        
        /* Attachment buttons */
        .attachment-btn {
            padding: 8px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .attachment-btn:hover {
            background-color: #e9ecef;
        }
        
        .dark-theme .attachment-btn:hover {
            background-color: #2a2a4a;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">CampusChat</span>
            <div class="d-flex">
                <button class="btn btn-outline-light btn-sm me-2" id="themeToggle">
                    <i class="bi bi-moon-fill"></i>
                </button>
                <button class="btn btn-outline-danger btn-sm" id="btnSignout">Sign out</button>
            </div>
        </div>
    </nav>

    <!-- Main content -->
    <div class="container-fluid main">
        <!-- Auth Section -->
        <div id="authSection">
            <div class="row justify-content-center mt-5">
                <div class="col-12 col-md-6 col-lg-4">
                    <div class="card p-4 shadow">
                        <h4 class="text-center mb-4">Welcome to CampusChat</h4>
                        
                        <!-- Login Form -->
                        <div id="loginForm">
                            <div class="mb-3">
                                <label for="loginEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="loginEmail" placeholder="Enter your email">
                            </div>
                            <div class="mb-3">
                                <label for="loginPass" class="form-label">Password</label>
                                <input type="password" class="form-control" id="loginPass" placeholder="Enter your password">
                            </div>
                            <div class="d-grid gap-2 mb-3">
                                <button id="btnLogin" class="btn btn-primary">Login</button>
                            </div>
                            <div class="d-grid gap-2 mb-3">
                                <button id="btnGoogle" class="btn btn-outline-danger">
                                    <i class="bi bi-google me-2"></i>Sign in with Google
                                </button>
                            </div>
                            <div class="text-center">
                                <button id="showSignup" class="btn btn-link">Create new account</button>
                            </div>
                        </div>
                        
                        <!-- Signup Form -->
                        <div id="signupForm" class="hidden">
                            <div class="mb-3">
                                <label for="signupEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="signupEmail" placeholder="Enter your email">
                            </div>
                            <div class="mb-3">
                                <label for="signupPass" class="form-label">Password (6+ characters)</label>
                                <input type="password" class="form-control" id="signupPass" placeholder="Create a password">
                            </div>
                            <div class="mb-3">
                                <label for="signupName" class="form-label">Full Name</label>
                                <input type="text" class="form-control" id="signupName" placeholder="Enter your full name">
                            </div>
                            <div class="mb-3">
                                <label for="signupUsername" class="form-label">Username</label>
                                <input type="text" class="form-control" id="signupUsername" placeholder="Choose a username">
                            </div>
                            <div class="mb-3">
                                <label for="signupDept" class="form-label">Department (optional)</label>
                                <input type="text" class="form-control" id="signupDept" placeholder="Your department">
                            </div>
                            <div class="d-grid gap-2 mb-3">
                                <button id="btnSignup" class="btn btn-success">Create Account</button>
                            </div>
                            <div class="text-center">
                                <button id="showLogin" class="btn btn-link">Back to login</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- App UI (hidden initially) -->
        <div id="appUI" class="hidden">
            <!-- Section Tabs (Desktop) -->
            <div class="d-none d-md-flex gap-2 my-3">
                <button class="btn btn-outline-primary active" data-section="homeSection">
                    Home
                    <span id="homeNotificationBadge" class="notification-badge hidden"></span>
                </button>
                <button class="btn btn-outline-primary" data-section="chatsSection">
                    Chats
                    <span id="chatsNotificationBadge" class="notification-badge hidden"></span>
                </button>
                <button class="btn btn-outline-primary" data-section="groupsSection">
                    Groups
                    <span id="groupsNotificationBadge" class="notification-badge hidden"></span>
                </button>
                <button class="btn btn-outline-primary" data-section="profileSection">
                    Profile
                    <span id="profileNotificationBadge" class="notification-badge hidden"></span>
                </button>
            </div>

            <!-- Main Content -->
            <div class="layout-grid">
                <!-- Home Section -->
                <div id="homeSection" class="section-content card p-3">
                    <div class="d-flex gap-2 mb-3">
                        <input id="postText" class="form-control" placeholder="What's on your mind?">
                        <input id="postImageInput" type="file" accept="image/*" class="d-none">
                        <input id="postVoiceInput" type="file" accept="audio/*" class="d-none">
                        <div class="btn-group">
                            <button id="btnAddImage" class="btn btn-outline-secondary">
                                <i class="bi bi-image"></i>
                            </button>
                            <button id="btnAddVoice" class="btn btn-outline-secondary">
                                <i class="bi bi-mic"></i>
                            </button>
                        </div>
                        <button id="btnPost" class="btn btn-primary">Post</button>
                    </div>
                    <div id="imagePreview" class="mb-3 hidden"></div>
                    <div id="voicePreview" class="mb-3 hidden"></div>
                    <div id="feed"></div>
                </div>

                <!-- Chats Section -->
                <div id="chatsSection" class="section-content hidden">
                    <div class="chats-layout">
                        <!-- Left: Users & Chats -->
                        <div class="card p-3">
                            <div class="d-flex align-items-center justify-content-between mb-3">
                                <h5>Chats & Users</h5>
                                <div>
                                    <button id="btnRefreshUsers" class="btn btn-sm btn-outline-secondary me-1">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                    <button id="btnCreateGroup" class="btn btn-sm btn-primary">
                                        <i class="bi bi-plus-circle"></i> Group
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Search Users -->
                            <div class="mb-3 position-relative">
                                <input id="searchUsers" class="form-control" placeholder="Search by username or name...">
                                <div id="searchResults" class="dropdown-list hidden"></div>
                            </div>
                            
                            <!-- Users List -->
                            <h6 class="mt-4">Recent Chats</h6>
                            <div id="usersList" class="list-group" style="max-height: 50vh; overflow-y: auto;"></div>
                            
                            <hr>
                            
                            <!-- Groups List -->
                            <h6>Your Groups</h6>
                            <div id="groupsList" style="max-height: 20vh; overflow-y: auto;"></div>
                        </div>

                        <!-- Right: Messages -->
                        <div class="card p-0">
                            <div id="activeChatHeader" class="chat-header">
                                <div class="avatar" id="activeAvatar"></div>
                                <div>
                                    <div id="activeName" style="font-weight: 600;"></div>
                                    <div id="activeMeta" class="small text-muted"></div>
                                </div>
                            </div>
                            
                            <div id="messagesWrap" style="height: 50vh; overflow-y: auto; padding: 8px;">
                                <div id="messages"></div>
                            </div>
                            
                            <div class="d-flex align-items-center gap-2 p-2">
                                <div class="btn-group">
                                    <button id="btnAttachFile" class="attachment-btn">
                                        <i class="bi bi-paperclip"></i>
                                    </button>
                                    <button id="btnRecordVoice" class="attachment-btn">
                                        <i class="bi bi-mic"></i>
                                    </button>
                                </div>
                                <input id="msgInput" class="form-control" placeholder="Type a message...">
                                <button id="btnSendMsg" class="btn btn-primary">
                                    <i class="bi bi-send"></i>
                                </button>
                            </div>
                            <div id="recordingIndicator" class="px-2 pb-2 hidden">
                                <span class="recording-indicator"></span>
                                <span class="text-danger">Recording... Click to stop</span>
                            </div>
                            <div class="px-2 pb-2">
                                <span id="typingIndicator" class="typing-indicator"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Groups Section -->
                <div id="groupsSection" class="section-content hidden card p-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5>Group Chats</h5>
                        <button id="btnShowCreateGroup" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> Create Group
                        </button>
                    </div>
                    
                    <div id="groupsContainer">
                        <div class="mb-3">
                            <h6>Your Groups</h6>
                            <div id="groupsListMain" class="list-group" style="max-height: 30vh; overflow-y: auto;"></div>
                        </div>
                        
                        <div id="selectedGroupView" class="hidden">
                            <div class="d-flex align-items-center justify-content-between mb-3">
                                <h5 id="selectedGroupName">Group Name</h5>
                                <button id="btnAddMember" class="btn btn-sm btn-success">
                                    <i class="bi bi-person-plus"></i> Add Member
                                </button>
                            </div>
                            
                            <div class="mb-3">
                                <h6>Members</h6>
                                <div id="groupMembersList" style="max-height: 20vh; overflow-y: auto;"></div>
                            </div>
                            
                            <div class="mb-3">
                                <h6>Group Chat</h6>
                                <div id="groupMessages" style="height: 30vh; overflow-y: auto; padding: 8px; border: 1px solid #dee2e6; border-radius: 8px; margin-bottom: 10px;"></div>
                                
                                <div class="d-flex align-items-center gap-2">
                                    <div class="btn-group">
                                        <button id="btnAttachGroupFile" class="attachment-btn">
                                            <i class="bi bi-paperclip"></i>
                                        </button>
                                        <button id="btnRecordGroupVoice" class="attachment-btn">
                                            <i class="bi bi-mic"></i>
                                        </button>
                                    </div>
                                    <input id="groupMsgInput" class="form-control" placeholder="Type a message...">
                                    <button id="btnSendGroupMsg" class="btn btn-primary">
                                        <i class="bi bi-send"></i>
                                    </button>
                                </div>
                                <div id="groupRecordingIndicator" class="mt-2 hidden">
                                    <span class="recording-indicator"></span>
                                    <span class="text-danger">Recording... Click to stop</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Profile Section -->
                <div id="profileSection" class="section-content hidden">
                    <div class="profile-layout">
                        <!-- Profile Editor -->
                        <div class="card p-3">
                            <h5>Your Profile</h5>
                            <div class="d-flex align-items-center gap-3 mb-4">
                                <div class="avatar" id="profileAvatar" style="width: 80px; height: 80px;"></div>
                                <div>
                                    <h4 id="profileName">Your Name</h4>
                                    <p id="profileDept" class="text-muted">Department</p>
                                    <p id="profileBio" class="text-muted">Bio will appear here</p>
                                    <p id="profileUID" class="text-muted small">UID: <span id="profileUIDValue"></span></p>
                                </div>
                            </div>
                            
                            <button id="btnEditProfile" class="btn btn-outline-primary btn-sm w-100 mb-3">
                                <i class="bi bi-pencil"></i> Edit Profile
                            </button>
                            
                            <div class="mb-3">
                                <h6>Profile Lookup</h6>
                                <div class="input-group mb-2">
                                    <input id="lookupUID" class="form-control" placeholder="Search by username, name, or UID">
                                    <button id="btnLookup" class="btn btn-outline-secondary">Search</button>
                                </div>
                                <div id="searchProfileResults" class="dropdown-list hidden"></div>
                                <div id="lookupResult" class="mt-3"></div>
                            </div>
                        </div>

                        <!-- Right: Profile & Notifications -->
                        <div class="card p-3">
                            <div class="d-flex align-items-center gap-3 mb-3">
                                <div class="avatar" id="myAvatar"></div>
                                <div>
                                    <strong id="myName">Your Name</strong>
                                    <br>
                                    <small id="myDept" class="text-muted">Department</small>
                                    <br>
                                    <small id="myUID" class="text-muted">UID: Loading...</small>
                                </div>
                            </div>
                            
                            <h6>Notifications</h6>
                            <div id="notifications" style="max-height: 40vh; overflow-y: auto;"></div>
                            
                            <h6 class="mt-3">Console</h6>
                            <div class="console-log" id="consoleLog">
                                <div>Initializing app...</div>
                            </div>
                            <button class="btn btn-sm btn-outline-secondary mt-2" id="btnClearConsole">Clear</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation (Mobile) -->
    <div class="bottom-nav d-flex d-md-none">
        <div class="nav-btn active" data-section="homeSection">
            <i class="bi bi-house-door"></i>
            <br>
            <small>Home <span id="homeNotificationBadgeMobile" class="notification-badge hidden"></span></small>
        </div>
        <div class="nav-btn" data-section="chatsSection">
            <i class="bi bi-chat-dots"></i>
            <br>
            <small>Chats <span id="chatsNotificationBadgeMobile" class="notification-badge hidden"></span></small>
        </div>
        <div class="nav-btn" data-section="groupsSection">
            <i class="bi bi-people"></i>
            <br>
            <small>Groups <span id="groupsNotificationBadgeMobile" class="notification-badge hidden"></span></small>
        </div>
        <div class="nav-btn" data-section="profileSection">
            <i class="bi bi-person"></i>
            <br>
            <small>Profile <span id="profileNotificationBadgeMobile" class="notification-badge hidden"></span></small>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="edit-profile-modal">
        <div class="edit-profile-content card">
            <div class="card-body">
                <h5 class="card-title">Edit Profile</h5>
                <div class="mb-3">
                    <label for="editName" class="form-label">Full Name</label>
                    <input type="text" class="form-control" id="editName">
                </div>
                <div class="mb-3">
                    <label for="editDepartment" class="form-label">Department</label>
                    <input type="text" class="form-control" id="editDepartment">
                </div>
                <div class="mb-3">
                    <label for="editBio" class="form-label">Bio</label>
                    <textarea class="form-control" id="editBio" rows="3"></textarea>
                </div>
                <div class="mb-3">
                    <label for="editUID" class="form-label">Custom UID (optional)</label>
                    <input type="text" class="form-control" id="editUID" placeholder="Set a custom UID">
                    <div class="form-text">This will be your unique identifier for other users to find you</div>
                </div>
                <div class="d-flex justify-content-end gap-2">
                    <button type="button" class="btn btn-secondary" id="btnCancelEdit">Cancel</button>
                    <button type="button" class="btn btn-primary" id="btnSaveProfile">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Group Modal -->
    <div id="createGroupModal" class="modal">
        <div class="modal-content card">
            <div class="card-body">
                <h5 class="card-title">Create New Group</h5>
                <div class="mb-3">
                    <label for="newGroupName" class="form-label">Group Name</label>
                    <input type="text" class="form-control" id="newGroupName" placeholder="Enter group name">
                </div>
                <div class="d-flex justify-content-end gap-2">
                    <button type="button" class="btn btn-secondary" id="btnCancelCreateGroup">Cancel</button>
                    <button type="button" class="btn btn-primary" id="btnCreateGroupModal">Create Group</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Member Modal -->
    <div id="addMemberModal" class="modal">
        <div class="modal-content card">
            <div class="card-body">
                <h5 class="card-title">Add Member to Group</h5>
                <div class="mb-3">
                    <label for="memberUID" class="form-label">User UID</label>
                    <input type="text" class="form-control" id="memberUID" placeholder="Enter user's UID">
                    <div class="form-text">You can find a user's UID in their profile</div>
                </div>
                <div class="d-flex justify-content-end gap-2">
                    <button type="button" class="btn btn-secondary" id="btnCancelAddMember">Cancel</button>
                    <button type="button" class="btn btn-primary" id="btnAddMemberModal">Add Member</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="fileInput" class="d-none" accept="*">
    <input type="file" id="groupFileInput" class="d-none" accept="*">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD6KXBiWGeEWjeG4xWEInfLzkCJGCiNQeE",
            authDomain: "cn-hub.firebaseapp.com",
            projectId: "cn-hub",
            storageBucket: "cn-hub.firebasestorage.app",
            messagingSenderId: "209615054369",
            appId: "1:209615054369:web:0d33a1f32a5de1dc742560",
            measurementId: "G-LMW8SG72D8"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // App state
        let currentUser = null;
        let allUsers = [];
        let activeChat = null;
        let activeGroup = null;
        let unsubscribeMessages = null;
        let unsubscribeGroupMessages = null;
        let typingTimeout = null;
        let unsubscribePosts = null;
        let selectedGroup = null;
        let messageListeners = {};
        let groupListeners = {};
        let notificationCounts = {
            chats: 0,
            groups: 0,
            home: 0,
            profile: 0
        };
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let lastDateSeparator = null;

        // DOM Elements
        const authSection = document.getElementById('authSection');
        const appUI = document.getElementById('appUI');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const btnSignout = document.getElementById('btnSignout');
        const themeToggle = document.getElementById('themeToggle');
        const editProfileModal = document.getElementById('editProfileModal');
        const createGroupModal = document.getElementById('createGroupModal');
        const addMemberModal = document.getElementById('addMemberModal');
        
        // Initialize the app
        function initApp() {
            console.log("Initializing app...");
            logToConsole("Initializing app...");
            
            // Check theme preference
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-theme');
                themeToggle.innerHTML = '<i class="bi bi-sun-fill"></i>';
            }
            
            // Auth state observer
            auth.onAuthStateChanged(user => {
                const authChangeMsg = "Auth state changed: " + (user ? "User logged in" : "No user");
                console.log(authChangeMsg);
                logToConsole(authChangeMsg);
                
                if (user) {
                    currentUser = user;
                    getUserProfile(user.uid);
                    authSection.classList.add('hidden');
                    appUI.classList.remove('hidden');
                    btnSignout.classList.remove('d-none');
                    loadUsers();
                    loadGroups();
                    loadFeed();
                    setupSectionSwitching();
                    setupNotificationListeners();
                } else {
                    currentUser = null;
                    authSection.classList.remove('hidden');
                    appUI.classList.add('hidden');
                    btnSignout.classList.add('d-none');
                    
                    // Clean up listeners
                    Object.values(messageListeners).forEach(unsubscribe => unsubscribe());
                    Object.values(groupListeners).forEach(unsubscribe => unsubscribe());
                    messageListeners = {};
                    groupListeners = {};
                }
            });

            // Auth event listeners
            document.getElementById('btnLogin').addEventListener('click', signIn);
            document.getElementById('btnSignup').addEventListener('click', signUp);
            document.getElementById('btnGoogle').addEventListener('click', signInWithGoogle);
            document.getElementById('showSignup').addEventListener('click', () => toggleAuthForms('signup'));
            document.getElementById('showLogin').addEventListener('click', () => toggleAuthForms('login'));
            
            // Check if elements exist before adding event listeners
            if (btnSignout) {
                btnSignout.addEventListener('click', signOut);
            }
            
            if (themeToggle) {
                themeToggle.addEventListener('click', toggleTheme);
            }

            // Search functionality
            const searchUsers = document.getElementById('searchUsers');
            if (searchUsers) {
                searchUsers.addEventListener('input', handleUserSearch);
            }
            
            const lookupUID = document.getElementById('lookupUID');
            if (lookupUID) {
                lookupUID.addEventListener('input', handleProfileSearch);
            }
            
            const btnLookup = document.getElementById('btnLookup');
            if (btnLookup) {
                btnLookup.addEventListener('click', lookupProfile);
            }
            
            // Post functionality
            const btnPost = document.getElementById('btnPost');
            if (btnPost) {
                btnPost.addEventListener('click', createPost);
            }
            
            const btnAddImage = document.getElementById('btnAddImage');
            if (btnAddImage) {
                btnAddImage.addEventListener('click', () => {
                    const postImageInput = document.getElementById('postImageInput');
                    if (postImageInput) postImageInput.click();
                });
            }
            
            const btnAddVoice = document.getElementById('btnAddVoice');
            if (btnAddVoice) {
                btnAddVoice.addEventListener('click', () => {
                    const postVoiceInput = document.getElementById('postVoiceInput');
                    if (postVoiceInput) postVoiceInput.click();
                });
            }
            
            const postImageInput = document.getElementById('postImageInput');
            if (postImageInput) {
                postImageInput.addEventListener('change', handleImagePreview);
            }
            
            const postVoiceInput = document.getElementById('postVoiceInput');
            if (postVoiceInput) {
                postVoiceInput.addEventListener('change', handleVoicePreview);
            }
            
            // Edit profile functionality
            const btnEditProfile = document.getElementById('btnEditProfile');
            if (btnEditProfile) {
                btnEditProfile.addEventListener('click', showEditProfileModal);
            }
            
            const btnCancelEdit = document.getElementById('btnCancelEdit');
            if (btnCancelEdit) {
                btnCancelEdit.addEventListener('click', hideEditProfileModal);
            }
            
            const btnSaveProfile = document.getElementById('btnSaveProfile');
            if (btnSaveProfile) {
                btnSaveProfile.addEventListener('click', saveProfile);
            }
            
            // Group functionality
            const btnShowCreateGroup = document.getElementById('btnShowCreateGroup');
            if (btnShowCreateGroup) {
                btnShowCreateGroup.addEventListener('click', showCreateGroupModal);
            }
            
            const btnCancelCreateGroup = document.getElementById('btnCancelCreateGroup');
            if (btnCancelCreateGroup) {
                btnCancelCreateGroup.addEventListener('click', hideCreateGroupModal);
            }
            
            const btnCreateGroupModal = document.getElementById('btnCreateGroupModal');
            if (btnCreateGroupModal) {
                btnCreateGroupModal.addEventListener('click', createGroup);
            }
            
            const btnAddMember = document.getElementById('btnAddMember');
            if (btnAddMember) {
                btnAddMember.addEventListener('click', showAddMemberModal);
            }
            
            const btnCancelAddMember = document.getElementById('btnCancelAddMember');
            if (btnCancelAddMember) {
                btnCancelAddMember.addEventListener('click', hideAddMemberModal);
            }
            
            const btnAddMemberModal = document.getElementById('btnAddMemberModal');
            if (btnAddMemberModal) {
                btnAddMemberModal.addEventListener('click', addMemberToGroup);
            }
            
            // Group message functionality
            const btnSendGroupMsg = document.getElementById('btnSendGroupMsg');
            if (btnSendGroupMsg) {
                btnSendGroupMsg.addEventListener('click', sendGroupMessage);
            }
            
            const groupMsgInput = document.getElementById('groupMsgInput');
            if (groupMsgInput) {
                groupMsgInput.addEventListener('keypress', e => {
                    if (e.key === 'Enter') {
                        sendGroupMessage();
                    }
                });
            }
            
            // Console functionality
            const btnClearConsole = document.getElementById('btnClearConsole');
            if (btnClearConsole) {
                btnClearConsole.addEventListener('click', () => {
                    document.getElementById('consoleLog').innerHTML = '<div>Console cleared</div>';
                });
            }
            
            // File attachment functionality
            const btnAttachFile = document.getElementById('btnAttachFile');
            if (btnAttachFile) {
                btnAttachFile.addEventListener('click', () => {
                    document.getElementById('fileInput').click();
                });
            }
            
            const btnAttachGroupFile = document.getElementById('btnAttachGroupFile');
            if (btnAttachGroupFile) {
                btnAttachGroupFile.addEventListener('click', () => {
                    document.getElementById('groupFileInput').click();
                });
            }
            
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.addEventListener('change', handleFileUpload);
            }
            
            const groupFileInput = document.getElementById('groupFileInput');
            if (groupFileInput) {
                groupFileInput.addEventListener('change', handleGroupFileUpload);
            }
            
            // Voice recording functionality
            const btnRecordVoice = document.getElementById('btnRecordVoice');
            if (btnRecordVoice) {
                btnRecordVoice.addEventListener('click', toggleVoiceRecording);
            }
            
            const btnRecordGroupVoice = document.getElementById('btnRecordGroupVoice');
            if (btnRecordGroupVoice) {
                btnRecordGroupVoice.addEventListener('click', toggleGroupVoiceRecording);
            }
            
            const recordingIndicator = document.getElementById('recordingIndicator');
            if (recordingIndicator) {
                recordingIndicator.addEventListener('click', stopVoiceRecording);
            }
            
            const groupRecordingIndicator = document.getElementById('groupRecordingIndicator');
            if (groupRecordingIndicator) {
                groupRecordingIndicator.addEventListener('click', stopVoiceRecording);
            }
            
            // Initialize modals
            initModals();
            
            // Ensure modals are hidden
            hideAllModals();
        }

        // Function to hide all modals
        function hideAllModals() {
            createGroupModal.style.display = 'none';
            addMemberModal.style.display = 'none';
            editProfileModal.classList.remove('show');
        }

        // Function to log messages to console UI
        function logToConsole(message) {
            const consoleElement = document.getElementById('consoleLog');
            if (consoleElement) {
                const logEntry = document.createElement('div');
                logEntry.textContent = new Date().toLocaleTimeString() + ': ' + message;
                consoleElement.appendChild(logEntry);
                consoleElement.scrollTop = consoleElement.scrollHeight;
            }
        }

        // Toggle between login and signup forms
        function toggleAuthForms(formToShow) {
            if (formToShow === 'signup') {
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
            } else {
                signupForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
            }
        }

        // Toggle theme
        function toggleTheme() {
            if (document.body.classList.contains('dark-theme')) {
                document.body.classList.remove('dark-theme');
                themeToggle.innerHTML = '<i class="bi bi-moon-fill"></i>';
                localStorage.setItem('theme', 'light');
            } else {
                document.body.classList.add('dark-theme');
                themeToggle.innerHTML = '<i class="bi bi-sun-fill"></i>';
                localStorage.setItem('theme', 'dark');
            }
        }

        // Sign in with email and password
        function signIn() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPass').value;
            
            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    logToConsole("User signed in successfully");
                })
                .catch(error => {
                    const errorMsg = 'Error signing in: ' + error.message;
                    alert(errorMsg);
                    logToConsole(errorMsg);
                });
        }

        // Sign up with email and password
        function signUp() {
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPass').value;
            const name = document.getElementById('signupName').value;
            const username = document.getElementById('signupUsername').value;
            const department = document.getElementById('signupDept').value;
            
            if (!username) {
                alert('Please choose a username');
                return;
            }
            
            // Check if username is available
            db.collection('users').where('username', '==', username).get()
                .then(snapshot => {
                    if (!snapshot.empty) {
                        alert('Username is already taken. Please choose another one.');
                        return;
                    }
                    
                    // Create the user
                    auth.createUserWithEmailAndPassword(email, password)
                        .then(userCredential => {
                            // Create user profile with safe defaults
                            return db.collection('users').doc(userCredential.user.uid).set({
                                email: email,
                                name: name,
                                username: username,
                                department: department || '',
                                bio: '',
                                customUID: '', // Initialize custom UID
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        })
                        .then(() => {
                            logToConsole("User account created successfully");
                        })
                        .catch(error => {
                            const errorMsg = 'Error creating account: ' + error.message;
                            alert(errorMsg);
                            logToConsole(errorMsg);
                        });
                })
                .catch(error => {
                    const errorMsg = 'Error checking username: ' + error.message;
                    alert(errorMsg);
                    logToConsole(errorMsg);
                });
        }

        // Sign in with Google
        function signInWithGoogle() {
            alert('Google sign-in would be implemented here. For now, use email/password authentication.');
        }

        // Sign out
        function signOut() {
            if (unsubscribeMessages) {
                unsubscribeMessages();
            }
            if (unsubscribeGroupMessages) {
                unsubscribeGroupMessages();
            }
            if (unsubscribePosts) {
                unsubscribePosts();
            }
            auth.signOut()
                .then(() => {
                    logToConsole("User signed out successfully");
                })
                .catch(error => {
                    const errorMsg = 'Error signing out: ' + error.message;
                    alert(errorMsg);
                    logToConsole(errorMsg);
                });
        }

        // Get user profile from Firestore with safety checks
        function getUserProfile(uid) {
            db.collection('users').doc(uid).get()
                .then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        
                        // Safely update profile elements
                        const myName = document.getElementById('myName');
                        const myDept = document.getElementById('myDept');
                        const myAvatar = document.getElementById('myAvatar');
                        const myUID = document.getElementById('myUID');
                        const profileName = document.getElementById('profileName');
                        const profileDept = document.getElementById('profileDept');
                        const profileBio = document.getElementById('profileBio');
                        const profileAvatar = document.getElementById('profileAvatar');
                        const profileUIDValue = document.getElementById('profileUIDValue');
                        
                        if (myName) myName.textContent = userData.name || 'Unknown';
                        if (myDept) myDept.textContent = userData.department || 'No department specified';
                        if (myUID) myUID.textContent = `UID: ${userData.customUID || uid}`;
                        if (profileName) profileName.textContent = userData.name || 'Unknown';
                        if (profileDept) profileDept.textContent = userData.department || 'No department specified';
                        if (profileBio) profileBio.textContent = userData.bio || 'No bio yet';
                        if (profileUIDValue) profileUIDValue.textContent = userData.customUID || uid;
                        
                        // Set avatar initials
                        const initials = userData.name ? userData.name.charAt(0).toUpperCase() : 'U';
                        if (myAvatar) myAvatar.textContent = initials;
                        if (profileAvatar) profileAvatar.textContent = initials;
                        
                        logToConsole("User profile loaded successfully");
                    } else {
                        console.warn("User document doesn't exist");
                        logToConsole("User document doesn't exist");
                    }
                })
                .catch(error => {
                    console.error("Error getting user profile:", error);
                    logToConsole("Error getting user profile: " + error.message);
                });
        }

        // Load all users for chat with safety checks
        function loadUsers() {
            db.collection('users').onSnapshot(snapshot => {
                allUsers = [];
                const usersList = document.getElementById('usersList');
                if (!usersList) return;
                
                usersList.innerHTML = '';
                
                snapshot.forEach(doc => {
                    if (doc.id !== currentUser.uid) {
                        const user = { id: doc.id, ...doc.data() };
                        allUsers.push(user);
                        
                        const userElement = document.createElement('div');
                        userElement.className = 'list-group-item list-group-item-action';
                        
                        // Create avatar with initials
                        const avatarDiv = document.createElement('div');
                        avatarDiv.className = 'avatar me-2';
                        avatarDiv.textContent = user.name ? user.name.charAt(0).toUpperCase() : 'U';
                        
                        userElement.innerHTML = `
                            <div class="d-flex align-items-center">
                                ${avatarDiv.outerHTML}
                                <div>
                                    <div>${user.name || 'Unknown User'}</div>
                                    <small class="text-muted">@${user.username || 'unknown'}</small>
                                </div>
                            </div>
                        `;
                        
                        userElement.addEventListener('click', () => {
                            openChat(user);
                        });
                        
                        usersList.appendChild(userElement);
                    }
                });
                
                logToConsole("Users list loaded successfully");
            }, error => {
                console.error("Error loading users:", error);
                logToConsole("Error loading users: " + error.message);
            });
        }

        // Setup section switching
        function setupSectionSwitching() {
            const sectionButtons = document.querySelectorAll('[data-section]');
            const sectionContents = document.querySelectorAll('.section-content');
            const navButtons = document.querySelectorAll('.nav-btn');
            
            sectionButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const sectionId = button.getAttribute('data-section');
                    showSection(sectionId);
                    
                    // Update active states
                    sectionButtons.forEach(btn => btn.classList.remove('active'));
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    
                    button.classList.add('active');
                    
                    // Also activate the corresponding nav button
                    const navBtn = document.querySelector(`.nav-btn[data-section="${sectionId}"]`);
                    if (navBtn) navBtn.classList.add('active');
                    
                    // Clear notifications for this section
                    if (sectionId === 'chatsSection') {
                        notificationCounts.chats = 0;
                    } else if (sectionId === 'groupsSection') {
                        notificationCounts.groups = 0;
                    }
                    updateNotificationBadges();
                });
            });
            
            // Mobile nav buttons
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const sectionId = button.getAttribute('data-section');
                    showSection(sectionId);
                    
                    // Update active states
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    sectionButtons.forEach(btn => btn.classList.remove('active'));
                    
                    button.classList.add('active');
                    
                    // Also activate the corresponding section button if visible
                    const correspondingButton = document.querySelector(`[data-section="${sectionId}"]`);
                    if (correspondingButton) {
                        correspondingButton.classList.add('active');
                    }
                    
                    // Clear notifications for this section
                    if (sectionId === 'chatsSection') {
                        notificationCounts.chats = 0;
                    } else if (sectionId === 'groupsSection') {
                        notificationCounts.groups = 0;
                    }
                    updateNotificationBadges();
                });
            });
        }

        // Show a specific section
        function showSection(sectionId) {
            // Hide all sections
            const sectionContents = document.querySelectorAll('.section-content');
            sectionContents.forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show the requested section
            const sectionElement = document.getElementById(sectionId);
            if (sectionElement) {
                sectionElement.classList.remove('hidden');
            }
        }

        // Open chat with a user
        function openChat(user) {
            // Unsubscribe from previous listeners
            if (unsubscribeMessages) {
                unsubscribeMessages();
            }
            
            activeChat = user;
            activeGroup = null;
            
            // Update UI
            const activeName = document.getElementById('activeName');
            const activeMeta = document.getElementById('activeMeta');
            const activeAvatar = document.getElementById('activeAvatar');
            
            if (activeName) activeName.textContent = user.name || 'Unknown User';
            if (activeMeta) activeMeta.textContent = `@${user.username || 'unknown'}`;
            
            // Set avatar with initials
            if (activeAvatar) {
                activeAvatar.textContent = user.name ? user.name.charAt(0).toUpperCase() : 'U';
            }
            
            // Clear messages
            const messagesContainer = document.getElementById('messages');
            if (messagesContainer) messagesContainer.innerHTML = '';
            lastDateSeparator = null;
            
            // Load messages
            loadMessages(user.id);
            
            // Switch to chats section
            showSection('chatsSection');
            
            // Update active states
            document.querySelectorAll('[data-section]').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            
            const chatsSectionBtn = document.querySelector('[data-section="chatsSection"]');
            const chatsNavBtn = document.querySelector('.nav-btn[data-section="chatsSection"]');
            
            if (chatsSectionBtn) chatsSectionBtn.classList.add('active');
            if (chatsNavBtn) chatsNavBtn.classList.add('active');
            
            logToConsole("Opened chat with " + (user.name || 'Unknown User'));
        }

        // Initialize modals
        function initModals() {
            // Create group modal
            const btnCreateGroup = document.getElementById('btnCreateGroup');
            if (btnCreateGroup) {
                btnCreateGroup.addEventListener('click', showCreateGroupModal);
            }
            
            // Send message on Enter key
            const msgInput = document.getElementById('msgInput');
            if (msgInput) {
                msgInput.addEventListener('keypress', e => {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }
            
            const btnSendMsg = document.getElementById('btnSendMsg');
            if (btnSendMsg) {
                btnSendMsg.addEventListener('click', sendMessage);
            }
        }

        // Send a message
        function sendMessage() {
            if (!activeChat) return;
            
            const messageInput = document.getElementById('msgInput');
            const text = messageInput.value.trim();
            
            if (!text) return;
            
            const chatId = [currentUser.uid, activeChat.id].sort().join('_');
            
            // Add message to Firestore
            db.collection('chats').doc(chatId).collection('messages').add({
                text: text,
                senderId: currentUser.uid,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                type: 'text'
            })
            .then(() => {
                logToConsole("Message sent successfully");
            })
            .catch(error => {
                console.error("Error sending message:", error);
                logToConsole("Error sending message: " + error.message);
            });
            
            // Clear input
            messageInput.value = '';
        }

        // Load messages for a chat
        function loadMessages(otherUserId) {
            const chatId = [currentUser.uid, otherUserId].sort().join('_');
            const messagesRef = db.collection('chats').doc(chatId).collection('messages')
                .orderBy('timestamp', 'asc');
            
            unsubscribeMessages = messagesRef.onSnapshot(snapshot => {
                const messagesContainer = document.getElementById('messages');
                if (!messagesContainer) return;
                
                messagesContainer.innerHTML = '';
                lastDateSeparator = null;
                
                snapshot.forEach(doc => {
                    const message = doc.data();
                    displayMessage(message);
                });
                
                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, error => {
                console.error("Error loading messages:", error);
                logToConsole("Error loading messages: " + error.message);
            });
        }

        // Display a message in the chat
        function displayMessage(message) {
            const messagesContainer = document.getElementById('messages');
            if (!messagesContainer) return;
            
            // Check if we need to add a date separator
            const messageDate = message.timestamp.toDate().toDateString();
            if (messageDate !== lastDateSeparator) {
                lastDateSeparator = messageDate;
                const dateSeparator = document.createElement('div');
                dateSeparator.className = 'date-separator';
                dateSeparator.innerHTML = `<span>${formatDate(message.timestamp.toDate())}</span>`;
                messagesContainer.appendChild(dateSeparator);
            }
            
            const messageDiv = document.createElement('div');
            
            // Format timestamp in GMT+1
            const timestamp = message.timestamp.toDate();
            const options = { timeZone: 'Europe/London', hour: '2-digit', minute: '2-digit' };
            const formattedTime = timestamp.toLocaleString('en-US', options);
            
            messageDiv.className = `message ${message.senderId === currentUser.uid ? 'sent' : 'received'}`;
            
            if (message.type === 'text') {
                messageDiv.innerHTML = `
                    <div>${message.text}</div>
                    <div class="message-time">${formattedTime}</div>
                `;
            } else if (message.type === 'file') {
                messageDiv.innerHTML = `
                    <div class="file-message">
                        <div class="file-icon"><i class="bi bi-file-earmark"></i></div>
                        <div>
                            <div><strong>${message.fileName}</strong></div>
                            <div class="small">${formatFileSize(message.fileSize)}</div>
                        </div>
                        <div class="ms-2">
                            <a href="${message.fileUrl}" download="${message.fileName}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-download"></i>
                            </a>
                        </div>
                    </div>
                    <div class="message-time">${formattedTime}</div>
                `;
            } else if (message.type === 'voice') {
                messageDiv.innerHTML = `
                    <div class="voice-message">
                        <div class="voice-icon"><i class="bi bi-mic"></i></div>
                        <div class="voice-player">
                            <audio controls>
                                <source src="${message.voiceUrl}" type="audio/webm">
                                Your browser does not support the audio element.
                            </audio>
                        </div>
                    </div>
                    <div class="message-time">${formattedTime}</div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
        }

        // Format date for display
        function formatDate(date) {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (date.toDateString() === today.toDateString()) {
                return 'Today';
            } else if (date.toDateString() === yesterday.toDateString()) {
                return 'Yesterday';
            } else {
                return date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            }
        }

        // Format file size for display
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' bytes';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            else return (bytes / 1048576).toFixed(1) + ' MB';
        }

        // Load feed posts with real-time updates
        function loadFeed() {
            const feed = document.getElementById('feed');
            if (!feed) return;
            
            // Unsubscribe from previous listener if exists
            if (unsubscribePosts) {
                unsubscribePosts();
            }
            
            // Set up real-time listener for posts
            unsubscribePosts = db.collection('posts')
                .orderBy('timestamp', 'desc')
                .onSnapshot(snapshot => {
                    feed.innerHTML = '';
                    
                    snapshot.forEach(doc => {
                        const post = { id: doc.id, ...doc.data() };
                        displayPost(post);
                    });
                    
                    logToConsole("Feed loaded successfully");
                }, error => {
                    console.error("Error loading posts:", error);
                    logToConsole("Error loading posts: " + error.message);
                });
        }

        // Display a post in the feed
        function displayPost(post) {
            const feed = document.getElementById('feed');
            if (!feed) return;
            
            const postElement = document.createElement('div');
            postElement.className = 'post';
            postElement.id = `post-${post.id}`;
            
            // Format timestamp
            const timestamp = post.timestamp.toDate();
            const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            const formattedTime = timestamp.toLocaleString('en-US', options);
            
            // Create avatar with initials
            const avatarText = post.authorName ? post.authorName.charAt(0).toUpperCase() : 'U';
            
            // Get user's current reaction if any
            const userReaction = post.reactions ? Object.keys(post.reactions).find(reaction => 
                post.reactions[reaction] && post.reactions[reaction].includes && post.reactions[reaction].includes(currentUser.uid)
            ) : null;
            
            postElement.innerHTML = `
                <div class="d-flex align-items-center mb-2">
                    <div class="avatar me-2">${avatarText}</div>
                    <div>
                        <div class="fw-bold">${post.authorName}</div>
                        <div class="post-time">${formattedTime}</div>
                    </div>
                </div>
            `;
            
            // Add post content based on type
            if (post.text) {
                postElement.innerHTML += `<p>${post.text}</p>`;
            }
            
            if (post.image) {
                postElement.innerHTML += `<img src="${post.image}" class="img-fluid rounded mb-2" style="max-height: 300px;">`;
            }
            
            if (post.voice) {
                postElement.innerHTML += `
                    <div class="voice-message mb-2">
                        <div class="voice-icon"><i class="bi bi-mic"></i></div>
                        <div class="voice-player">
                            <audio controls>
                                <source src="${post.voice}" type="audio/webm">
                                Your browser does not support the audio element.
                            </audio>
                        </div>
                    </div>
                `;
            }
            
            postElement.innerHTML += `
                <div class="d-flex align-items-center mb-2">
                    <button class="reaction-btn ${userReaction === 'like' ? 'active' : ''}" data-reaction="like" data-post="${post.id}">
                        👍 <span class="reaction-count">${post.reactions?.like?.length || 0}</span>
                    </button>
                    <button class="reaction-btn ${userReaction === 'love' ? 'active' : ''}" data-reaction="love" data-post="${post.id}">
                        ❤️ <span class="reaction-count">${post.reactions?.love?.length || 0}</span>
                    </button>
                    <button class="reaction-btn ${userReaction === 'laugh' ? 'active' : ''}" data-reaction="laugh" data-post="${post.id}">
                        😂 <span class="reaction-count">${post.reactions?.laugh?.length || 0}</span>
                    </button>
                    <button class="reaction-btn ${userReaction === 'wow' ? 'active' : ''}" data-reaction="wow" data-post="${post.id}">
                        😮 <span class="reaction-count">${post.reactions?.wow?.length || 0}</span>
                    </button>
                </div>
            `;
            
            feed.appendChild(postElement);
            
            // Add event listeners to reaction buttons
            postElement.querySelectorAll('.reaction-btn').forEach(btn => {
                btn.addEventListener('click', handleReaction);
            });
        }

        // Handle post reactions
        function handleReaction(event) {
            if (!currentUser) return;
            
            const reaction = event.currentTarget.getAttribute('data-reaction');
            const postId = event.currentTarget.getAttribute('data-post');
            
            // Get the current post data
            db.collection('posts').doc(postId).get()
                .then(doc => {
                    if (!doc.exists) return;
                    
                    const post = doc.data();
                    const reactions = post.reactions || {};
                    
                    // Initialize reaction array if it doesn't exist
                    if (!reactions[reaction]) {
                        reactions[reaction] = [];
                    }
                    
                    // Remove user from all other reactions
                    Object.keys(reactions).forEach(key => {
                        const index = reactions[key].indexOf(currentUser.uid);
                        if (index > -1) {
                            reactions[key].splice(index, 1);
                        }
                    });
                    
                    // Add user to this reaction if not already there
                    if (!reactions[reaction].includes(currentUser.uid)) {
                        reactions[reaction].push(currentUser.uid);
                    }
                    
                    // Update the post
                    return db.collection('posts').doc(postId).update({
                        reactions: reactions
                    });
                })
                .then(() => {
                    logToConsole("Reaction updated successfully");
                })
                .catch(error => {
                    console.error("Error updating reaction:", error);
                    logToConsole("Error updating reaction: " + error.message);
                });
        }

        // Create a new post
        function createPost() {
            const text = document.getElementById('postText').value;
            const imageFile = document.getElementById('postImageInput').files[0];
            const voiceFile = document.getElementById('postVoiceInput').files[0];
            
            if (!text.trim() && !imageFile && !voiceFile) return;
            
            // Get current user data
            db.collection('users').doc(currentUser.uid).get()
                .then(userDoc => {
                    if (!userDoc.exists) return;
                    
                    const userData = userDoc.data();
                    const postData = {
                        text: text.trim(),
                        authorId: currentUser.uid,
                        authorName: userData.name,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        reactions: {}
                    };
                    
                    const uploadPromises = [];
                    
                    if (imageFile) {
                        uploadPromises.push(
                            storage.ref(`post_images/${Date.now()}_${imageFile.name}`).put(imageFile)
                                .then(snapshot => snapshot.ref.getDownloadURL())
                                .then(url => {
                                    postData.image = url;
                                })
                        );
                    }
                    
                    if (voiceFile) {
                        uploadPromises.push(
                            storage.ref(`post_voices/${Date.now()}_${voiceFile.name}`).put(voiceFile)
                                .then(snapshot => snapshot.ref.getDownloadURL())
                                .then(url => {
                                    postData.voice = url;
                                })
                        );
                    }
                    
                    // Wait for all uploads to complete
                    Promise.all(uploadPromises).then(() => {
                        return db.collection('posts').add(postData);
                    })
                    .then(() => {
                        // Clear form
                        document.getElementById('postText').value = '';
                        document.getElementById('postImageInput').value = '';
                        document.getElementById('postVoiceInput').value = '';
                        document.getElementById('imagePreview').classList.add('hidden');
                        document.getElementById('imagePreview').innerHTML = '';
                        document.getElementById('voicePreview').classList.add('hidden');
                        document.getElementById('voicePreview').innerHTML = '';
                        
                        logToConsole("Post created successfully");
                    });
                })
                .catch(error => {
                    console.error("Error creating post:", error);
                    const errorMsg = 'Error creating post: ' + error.message;
                    alert(errorMsg);
                    logToConsole(errorMsg);
                });
        }

        // Handle image preview for posts
        function handleImagePreview() {
            const file = document.getElementById('postImageInput').files[0];
            const preview = document.getElementById('imagePreview');
            
            if (file) {
                preview.classList.remove('hidden');
                preview.innerHTML = `<img src="${URL.createObjectURL(file)}" class="img-fluid rounded" style="max-height: 200px;">`;
            } else {
                preview.classList.add('hidden');
                preview.innerHTML = '';
            }
        }

        // Handle voice preview for posts
        function handleVoicePreview() {
            const file = document.getElementById('postVoiceInput').files[0];
            const preview = document.getElementById('voicePreview');
            
            if (file) {
                preview.classList.remove('hidden');
                preview.innerHTML = `
                    <div class="voice-message">
                        <div class="voice-icon"><i class="bi bi-mic"></i></div>
                        <div class="voice-player">
                            <audio controls>
                                <source src="${URL.createObjectURL(file)}" type="${file.type}">
                                Your browser does not support the audio element.
                            </audio>
                        </div>
                    </div>
                `;
            } else {
                preview.classList.add('hidden');
                preview.innerHTML = '';
            }
        }

        // Show edit profile modal
        function showEditProfileModal() {
            // Get current user data
            db.collection('users').doc(currentUser.uid).get()
                .then(doc => {
                    if (!doc.exists) return;
                    
                    const userData = doc.data();
                    
                    // Fill the form with current data
                    document.getElementById('editName').value = userData.name || '';
                    document.getElementById('editDepartment').value = userData.department || '';
                    document.getElementById('editBio').value = userData.bio || '';
                    document.getElementById('editUID').value = userData.customUID || '';
                    
                    // Show the modal
                    editProfileModal.classList.add('show');
                })
                .catch(error => {
                    console.error("Error loading profile:", error);
                    logToConsole("Error loading profile: " + error.message);
                });
        }

        // Hide edit profile modal
        function hideEditProfileModal() {
            editProfileModal.classList.remove('show');
        }

        // Save profile changes
        function saveProfile() {
            const name = document.getElementById('editName').value;
            const department = document.getElementById('editDepartment').value;
            const bio = document.getElementById('editBio').value;
            const customUID = document.getElementById('editUID').value;
            
            // Update user profile
            db.collection('users').doc(currentUser.uid).update({
                name: name,
                department: department,
                bio: bio,
                customUID: customUID
            })
            .then(() => {
                // Update UI
                document.getElementById('myName').textContent = name;
                document.getElementById('myDept').textContent = department;
                document.getElementById('profileName').textContent = name;
                document.getElementById('profileDept').textContent = department;
                document.getElementById('profileBio').textContent = bio;
                document.getElementById('profileUIDValue').textContent = customUID || currentUser.uid;
                document.getElementById('myUID').textContent = `UID: ${customUID || currentUser.uid}`;
                
                // Update avatar initials
                const initials = name ? name.charAt(0).toUpperCase() : 'U';
                document.getElementById('myAvatar').textContent = initials;
                document.getElementById('profileAvatar').textContent = initials;
                
                // Hide the modal
                hideEditProfileModal();
                
                alert('Profile updated successfully!');
                logToConsole("Profile updated successfully");
            })
            .catch(error => {
                console.error("Error updating profile:", error);
                const errorMsg = 'Error updating profile: ' + error.message;
                alert(errorMsg);
                logToConsole(errorMsg);
            });
        }

        // Handle user search with dropdown
        function handleUserSearch(e) {
            const query = e.target.value.toLowerCase();
            const resultsContainer = document.getElementById('searchResults');
            
            if (query.length < 2) {
                resultsContainer.classList.add('hidden');
                return;
            }
            
            const filteredUsers = allUsers.filter(user => 
                (user.username && user.username.toLowerCase().includes(query)) || 
                (user.name && user.name.toLowerCase().includes(query)) ||
                (user.customUID && user.customUID.toLowerCase().includes(query)) ||
                (user.id && user.id.includes(query))
            );
            
            resultsContainer.innerHTML = '';
            
            if (filteredUsers.length > 0) {
                filteredUsers.forEach(user => {
                    const item = document.createElement('div');
                    item.className = 'dropdown-item';
                    
                    // Create avatar with initials
                    const avatarDiv = document.createElement('div');
                    avatarDiv.className = 'avatar me-2';
                    avatarDiv.textContent = user.name ? user.name.charAt(0).toUpperCase() : 'U';
                    
                    item.innerHTML = `
                        <div class="d-flex align-items-center">
                            ${avatarDiv.outerHTML}
                            <div>
                                <div>${user.name || 'Unknown User'}</div>
                                <small class="text-muted">@${user.username || 'unknown'} | ${user.customUID || user.id}</small>
                            </div>
                        </div>
                    `;
                    
                    item.addEventListener('click', () => {
                        openChat(user);
                        document.getElementById('searchUsers').value = '';
                        resultsContainer.classList.add('hidden');
                    });
                    
                    resultsContainer.appendChild(item);
                });
                
                resultsContainer.classList.remove('hidden');
            } else {
                resultsContainer.classList.add('hidden');
            }
        }

        // Handle profile search with dropdown
        function handleProfileSearch(e) {
            const query = e.target.value.toLowerCase();
            const resultsContainer = document.getElementById('searchProfileResults');
            
            if (query.length < 2) {
                resultsContainer.classList.add('hidden');
                return;
            }
            
            const filteredUsers = allUsers.filter(user => 
                (user.username && user.username.toLowerCase().includes(query)) || 
                (user.name && user.name.toLowerCase().includes(query)) ||
                (user.customUID && user.customUID.toLowerCase().includes(query)) ||
                (user.id && user.id.includes(query))
            );
            
            resultsContainer.innerHTML = '';
            
            if (filteredUsers.length > 0) {
                filteredUsers.forEach(user => {
                    const item = document.createElement('div');
                    item.className = 'dropdown-item';
                    
                    // Create avatar with initials
                    const avatarDiv = document.createElement('div');
                    avatarDiv.className = 'avatar me-2';
                    avatarDiv.textContent = user.name ? user.name.charAt(0).toUpperCase() : 'U';
                    
                    item.innerHTML = `
                        <div class="d-flex align-items-center">
                            ${avatarDiv.outerHTML}
                            <div>
                                <div>${user.name || 'Unknown User'}</div>
                                <small class="text-muted">@${user.username || 'unknown'} | ${user.customUID || user.id}</small>
                            </div>
                        </div>
                    `;
                    
                    item.addEventListener('click', () => {
                        document.getElementById('lookupUID').value = user.customUID || user.id;
                        resultsContainer.classList.add('hidden');
                        lookupProfile();
                    });
                    
                    resultsContainer.appendChild(item);
                });
                
                resultsContainer.classList.remove('hidden');
            } else {
                resultsContainer.classList.add('hidden');
            }
        }

        // Lookup profile by username or UID
        function lookupProfile() {
            const searchTerm = document.getElementById('lookupUID').value.trim();
            const resultContainer = document.getElementById('lookupResult');
            
            if (!searchTerm) {
                resultContainer.innerHTML = '<div class="alert alert-warning">Please enter a username or UID</div>';
                return;
            }
            
            // Search for user by username or UID
            const user = allUsers.find(u => 
                (u.username && u.username.toLowerCase() === searchTerm.toLowerCase()) || 
                (u.customUID && u.customUID.toLowerCase() === searchTerm.toLowerCase()) ||
                u.id === searchTerm
            );
            
            if (user) {
                resultContainer.innerHTML = `
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex align-items-center gap-3">
                                <div class="avatar" style="width: 60px; height: 60px;">${user.name ? user.name.charAt(0).toUpperCase() : 'U'}</div>
                                <div>
                                    <h5>${user.name || 'Unknown User'}</h5>
                                    <p class="mb-0">@${user.username || 'no username'}</p>
                                    <p class="mb-0 text-muted">${user.department || 'No department'}</p>
                                    <p class="mb-0 text-muted">UID: ${user.customUID || user.id}</p>
                                </div>
                            </div>
                            <p class="mt-3">${user.bio || 'No bio available'}</p>
                            <button class="btn btn-primary mt-2" id="btnStartChatWithUser">Start Chat</button>
                        </div>
                    </div>
                `;
                
                // Add event listener to the button
                document.getElementById('btnStartChatWithUser').addEventListener('click', () => {
                    openChat(user);
                });
            } else {
                resultContainer.innerHTML = '<div class="alert alert-warning">User not found</div>';
            }
        }

        // Load groups with safety checks
        function loadGroups() {
            const groupsListMain = document.getElementById('groupsListMain');
            const groupsListSidebar = document.getElementById('groupsList');
            
            if (!groupsListMain || !groupsListSidebar) return;
            
            // Listen for groups where the current user is a member
            db.collection('groups').where('members', 'array-contains', currentUser.uid).onSnapshot(snapshot => {
                groupsListMain.innerHTML = '';
                groupsListSidebar.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const group = { id: doc.id, ...doc.data() };
                    
                    const groupElement = document.createElement('div');
                    groupElement.className = 'list-group-item list-group-item-action';
                    
                    groupElement.innerHTML = `
                        <div class="d-flex align-items-center">
                            <div class="avatar me-2">${group.name ? group.name.charAt(0).toUpperCase() : 'G'}</div>
                            <div>
                                <div>${group.name || 'Unnamed Group'}</div>
                                <small class="text-muted">${group.members.length} members</small>
                            </div>
                        </div>
                    `;
                    
                    groupElement.addEventListener('click', () => {
                        selectGroup(group);
                    });
                    
                    groupsListMain.appendChild(groupElement.cloneNode(true));
                    groupsListSidebar.appendChild(groupElement);
                });
                
                logToConsole("Groups loaded successfully");
            }, error => {
                console.error("Error loading groups:", error);
                logToConsole("Error loading groups: " + error.message);
            });
        }

        // Select a group to view details
        function selectGroup(group) {
            selectedGroup = group;
            
            // Show group details view
            document.getElementById('selectedGroupView').classList.remove('hidden');
            document.getElementById('selectedGroupName').textContent = group.name || 'Unnamed Group';
            
            // Load group members
            loadGroupMembers(group);
            
            // Load group messages
            loadGroupMessages(group.id);
            
            logToConsole("Selected group: " + (group.name || 'Unnamed Group'));
        }

        // Load group members
        function loadGroupMembers(group) {
            const membersList = document.getElementById('groupMembersList');
            if (!membersList) return;
            
            membersList.innerHTML = '';
            
            // Get details for each member
            const memberPromises = group.members.map(memberId => {
                return db.collection('users').doc(memberId).get()
                    .then(doc => {
                        if (doc.exists) {
                            return { id: memberId, ...doc.data() };
                        }
                        return { id: memberId, name: 'Unknown User' };
                    });
            });
            
            Promise.all(memberPromises).then(members => {
                members.forEach(member => {
                    const memberElement = document.createElement('div');
                    memberElement.className = 'group-member';
                    
                    const avatarDiv = document.createElement('div');
                    avatarDiv.className = 'avatar me-2';
                    avatarDiv.textContent = member.name ? member.name.charAt(0).toUpperCase() : 'U';
                    
                    memberElement.innerHTML = `
                        ${avatarDiv.outerHTML}
                        <div>
                            <div>${member.name || 'Unknown User'}</div>
                            <small class="text-muted">@${member.username || 'unknown'}</small>
                        </div>
                    `;
                    
                    // Add admin badge if this member is the admin
                    if (member.id === group.admin) {
                        const adminBadge = document.createElement('span');
                        adminBadge.className = 'admin-badge';
                        adminBadge.textContent = 'Admin';
                        memberElement.appendChild(adminBadge);
                    }
                    
                    membersList.appendChild(memberElement);
                });
            });
        }

        // Load group messages
        function loadGroupMessages(groupId) {
            // Unsubscribe from previous listener if exists
            if (unsubscribeGroupMessages) {
                unsubscribeGroupMessages();
            }
            
            const messagesRef = db.collection('groupMessages').doc(groupId).collection('messages')
                .orderBy('timestamp', 'asc');
            
            unsubscribeGroupMessages = messagesRef.onSnapshot(snapshot => {
                const messagesContainer = document.getElementById('groupMessages');
                if (!messagesContainer) return;
                
                messagesContainer.innerHTML = '';
                lastDateSeparator = null;
                
                snapshot.forEach(doc => {
                    const message = doc.data();
                    displayGroupMessage(message);
                });
                
                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, error => {
                console.error("Error loading group messages:", error);
                logToConsole("Error loading group messages: " + error.message);
            });
        }

        // Display a group message
        function displayGroupMessage(message) {
            const messagesContainer = document.getElementById('groupMessages');
            if (!messagesContainer) return;
            
            // Check if we need to add a date separator
            const messageDate = message.timestamp.toDate().toDateString();
            if (messageDate !== lastDateSeparator) {
                lastDateSeparator = messageDate;
                const dateSeparator = document.createElement('div');
                dateSeparator.className = 'date-separator';
                dateSeparator.innerHTML = `<span>${formatDate(message.timestamp.toDate())}</span>`;
                messagesContainer.appendChild(dateSeparator);
            }
            
            const messageDiv = document.createElement('div');
            
            // Format timestamp
            const timestamp = message.timestamp.toDate();
            const options = { timeZone: 'Europe/London', hour: '2-digit', minute: '2-digit' };
            const formattedTime = timestamp.toLocaleString('en-US', options);
            
            messageDiv.className = `message ${message.senderId === currentUser.uid ? 'sent' : 'received'}`;
            
            if (message.type === 'text') {
                messageDiv.innerHTML = `
                    <div><strong>${message.senderName || 'Unknown User'}:</strong> ${message.text}</div>
                    <div class="message-time">${formattedTime}</div>
                `;
            } else if (message.type === 'file') {
                messageDiv.innerHTML = `
                    <div><strong>${message.senderName || 'Unknown User'}:</strong></div>
                    <div class="file-message">
                        <div class="file-icon"><i class="bi bi-file-earmark"></i></div>
                        <div>
                            <div><strong>${message.fileName}</strong></div>
                            <div class="small">${formatFileSize(message.fileSize)}</div>
                        </div>
                        <div class="ms-2">
                            <a href="${message.fileUrl}" download="${message.fileName}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-download"></i>
                            </a>
                        </div>
                    </div>
                    <div class="message-time">${formattedTime}</div>
                `;
            } else if (message.type === 'voice') {
                messageDiv.innerHTML = `
                    <div><strong>${message.senderName || 'Unknown User'}:</strong></div>
                    <div class="voice-message">
                        <div class="voice-icon"><i class="bi bi-mic"></i></div>
                        <div class="voice-player">
                            <audio controls>
                                <source src="${message.voiceUrl}" type="audio/webm">
                                Your browser does not support the audio element.
                            </audio>
                        </div>
                    </div>
                    <div class="message-time">${formattedTime}</div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
        }

        // Send a group message
        function sendGroupMessage() {
            if (!selectedGroup) return;
            
            const messageInput = document.getElementById('groupMsgInput');
            const text = messageInput.value.trim();
            
            if (!text) return;
            
            // Get current user data
            db.collection('users').doc(currentUser.uid).get()
                .then(userDoc => {
                    if (!userDoc.exists) return;
                    
                    const userData = userDoc.data();
                    
                    // Add message to Firestore
                    return db.collection('groupMessages').doc(selectedGroup.id).collection('messages').add({
                        text: text,
                        senderId: currentUser.uid,
                        senderName: userData.name,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        type: 'text'
                    });
                })
                .then(() => {
                    // Clear input
                    messageInput.value = '';
                    logToConsole("Group message sent successfully");
                })
                .catch(error => {
                    console.error("Error sending group message:", error);
                    logToConsole("Error sending group message: " + error.message);
                });
        }

        // Show create group modal
        function showCreateGroupModal() {
            createGroupModal.style.display = 'flex';
        }

        // Hide create group modal
        function hideCreateGroupModal() {
            createGroupModal.style.display = 'none';
            document.getElementById('newGroupName').value = '';
        }

        // Create a new group
        function createGroup() {
            const groupName = document.getElementById('newGroupName').value.trim();
            
            if (!groupName) {
                alert('Please enter a group name');
                return;
            }
            
            // Create the group
            db.collection('groups').add({
                name: groupName,
                admin: currentUser.uid,
                members: [currentUser.uid],
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                hideCreateGroupModal();
                alert('Group created successfully!');
                logToConsole("Group created successfully: " + groupName);
            })
            .catch(error => {
                console.error("Error creating group:", error);
                const errorMsg = 'Error creating group: ' + error.message;
                alert(errorMsg);
                logToConsole(errorMsg);
            });
        }

        // Show add member modal
        function showAddMemberModal() {
            addMemberModal.style.display = 'flex';
        }

        // Hide add member modal
        function hideAddMemberModal() {
            addMemberModal.style.display = 'none';
            document.getElementById('memberUID').value = '';
        }

        // Add member to group
        function addMemberToGroup() {
            const memberUID = document.getElementById('memberUID').value.trim();
            
            if (!memberUID) {
                alert('Please enter a user UID');
                return;
            }
            
            if (!selectedGroup) {
                alert('No group selected');
                return;
            }
            
            // Check if user is already a member
            if (selectedGroup.members.includes(memberUID)) {
                alert('User is already a member of this group');
                return;
            }
            
            // Verify the user exists
            db.collection('users').doc(memberUID).get()
                .then(doc => {
                    if (!doc.exists) {
                        alert('User not found');
                        return;
                    }
                    
                    // Add user to group
                    const updatedMembers = [...selectedGroup.members, memberUID];
                    
                    return db.collection('groups').doc(selectedGroup.id).update({
                        members: updatedMembers
                    });
                })
                .then(() => {
                    hideAddMemberModal();
                    alert('Member added successfully!');
                    
                    // Update the selected group
                    selectedGroup.members.push(memberUID);
                    loadGroupMembers(selectedGroup);
                    
                    logToConsole("Member added to group: " + memberUID);
                })
                .catch(error => {
                    console.error("Error adding member:", error);
                    const errorMsg = 'Error adding member: ' + error.message;
                    alert(errorMsg);
                    logToConsole(errorMsg);
                });
        }

        // Handle file upload for private messages
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file || !activeChat) return;
            
            uploadFile(file, activeChat.id, false);
        }

        // Handle file upload for group messages
        function handleGroupFileUpload(event) {
            const file = event.target.files[0];
            if (!file || !selectedGroup) return;
            
            uploadFile(file, selectedGroup.id, true);
        }

        // Upload file to storage and add message
        function uploadFile(file, targetId, isGroup) {
            const storageRef = storage.ref(`${isGroup ? 'group_files' : 'chat_files'}/${Date.now()}_${file.name}`);
            
            storageRef.put(file)
                .then(snapshot => snapshot.ref.getDownloadURL())
                .then(url => {
                    // Create message data
                    const messageData = {
                        type: 'file',
                        fileName: file.name,
                        fileSize: file.size,
                        fileUrl: url,
                        senderId: currentUser.uid,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    if (isGroup) {
                        // Get current user data for sender name
                        return db.collection('users').doc(currentUser.uid).get()
                            .then(userDoc => {
                                if (!userDoc.exists) return;
                                
                                const userData = userDoc.data();
                                messageData.senderName = userData.name;
                                
                                // Add to group messages
                                return db.collection('groupMessages').doc(targetId).collection('messages').add(messageData);
                            });
                    } else {
                        // Add to private chat
                        const chatId = [currentUser.uid, targetId].sort().join('_');
                        return db.collection('chats').doc(chatId).collection('messages').add(messageData);
                    }
                })
                .then(() => {
                    logToConsole("File uploaded and message sent successfully");
                    // Clear file input
                    if (!isGroup) {
                        document.getElementById('fileInput').value = '';
                    } else {
                        document.getElementById('groupFileInput').value = '';
                    }
                })
                .catch(error => {
                    console.error("Error uploading file:", error);
                    logToConsole("Error uploading file: " + error.message);
                    alert('Error uploading file: ' + error.message);
                });
        }

        // Toggle voice recording for private messages
        function toggleVoiceRecording() {
            if (isRecording) {
                stopVoiceRecording();
            } else {
                startVoiceRecording(false);
            }
        }

        // Toggle voice recording for group messages
        function toggleGroupVoiceRecording() {
            if (isRecording) {
                stopVoiceRecording();
            } else {
                startVoiceRecording(true);
            }
        }

        // Start voice recording
        function startVoiceRecording(isGroup) {
            if (isRecording) return;
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert("Your browser doesn't support audio recording");
                return;
            }
            
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    isRecording = true;
                    audioChunks = [];
                    
                    // Show recording indicator
                    if (isGroup) {
                        document.getElementById('groupRecordingIndicator').classList.remove('hidden');
                    } else {
                        document.getElementById('recordingIndicator').classList.remove('hidden');
                    }
                    
                    mediaRecorder = new MediaRecorder(stream);
                    
                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        uploadVoiceNote(audioBlob, isGroup);
                        
                        // Stop all tracks
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorder.start();
                })
                .catch(error => {
                    console.error("Error accessing microphone:", error);
                    logToConsole("Error accessing microphone: " + error.message);
                    alert('Error accessing microphone: ' + error.message);
                });
        }

        // Stop voice recording
        function stopVoiceRecording() {
            if (!isRecording || !mediaRecorder) return;
            
            mediaRecorder.stop();
            isRecording = false;
            
            // Hide recording indicators
            document.getElementById('recordingIndicator').classList.add('hidden');
            document.getElementById('groupRecordingIndicator').classList.add('hidden');
        }

        // Upload voice note to storage and add message
        function uploadVoiceNote(audioBlob, isGroup) {
            const targetId = isGroup ? selectedGroup.id : activeChat.id;
            if (!targetId) return;
            
            const fileName = `voice_${Date.now()}.webm`;
            const storageRef = storage.ref(`${isGroup ? 'group_voices' : 'chat_voices'}/${fileName}`);
            
            storageRef.put(audioBlob)
                .then(snapshot => snapshot.ref.getDownloadURL())
                .then(url => {
                    // Create message data
                    const messageData = {
                        type: 'voice',
                        voiceUrl: url,
                        senderId: currentUser.uid,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    if (isGroup) {
                        // Get current user data for sender name
                        return db.collection('users').doc(currentUser.uid).get()
                            .then(userDoc => {
                                if (!userDoc.exists) return;
                                
                                const userData = userDoc.data();
                                messageData.senderName = userData.name;
                                
                                // Add to group messages
                                return db.collection('groupMessages').doc(targetId).collection('messages').add(messageData);
                            });
                    } else {
                        // Add to private chat
                        const chatId = [currentUser.uid, targetId].sort().join('_');
                        return db.collection('chats').doc(chatId).collection('messages').add(messageData);
                    }
                })
                .then(() => {
                    logToConsole("Voice note uploaded and message sent successfully");
                })
                .catch(error => {
                    console.error("Error uploading voice note:", error);
                    logToConsole("Error uploading voice note: " + error.message);
                    alert('Error uploading voice note: ' + error.message);
                });
        }

        // Setup notification listeners for chats and groups
        function setupNotificationListeners() {
            // Listen for all chats where current user is a participant
            db.collection('chats')
                .where('participants', 'array-contains', currentUser.uid)
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added' || change.type === 'modified') {
                            const chatId = change.doc.id;
                            // Set up listener for messages in this chat
                            if (!messageListeners[chatId]) {
                                messageListeners[chatId] = db.collection('chats').doc(chatId)
                                    .collection('messages')
                                    .orderBy('timestamp', 'desc')
                                    .limit(1)
                                    .onSnapshot(msgSnapshot => {
                                        msgSnapshot.docChanges().forEach(msgChange => {
                                            if (msgChange.type === 'added') {
                                                const message = msgChange.doc.data();
                                                // If message is not from current user and not in active chat
                                                if (message.senderId !== currentUser.uid && 
                                                    (!activeChat || activeChat.id !== getOtherUserId(chatId))) {
                                                    notificationCounts.chats++;
                                                    updateNotificationBadges();
                                                }
                                            }
                                        });
                                    });
                            }
                        }
                    });
                }, error => {
                    console.error("Error setting up chat notifications:", error);
                    logToConsole("Error setting up chat notifications: " + error.message);
                });

            // Listen for all groups where current user is a member
            db.collection('groups')
                .where('members', 'array-contains', currentUser.uid)
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added' || change.type === 'modified') {
                            const groupId = change.doc.id;
                            // Set up listener for messages in this group
                            if (!groupListeners[groupId]) {
                                groupListeners[groupId] = db.collection('groupMessages').doc(groupId)
                                    .collection('messages')
                                    .orderBy('timestamp', 'desc')
                                    .limit(1)
                                    .onSnapshot(msgSnapshot => {
                                        msgSnapshot.docChanges().forEach(msgChange => {
                                            if (msgChange.type === 'added') {
                                                const message = msgChange.doc.data();
                                                // If message is not from current user and not in active group
                                                if (message.senderId !== currentUser.uid && 
                                                    (!selectedGroup || selectedGroup.id !== groupId)) {
                                                    notificationCounts.groups++;
                                                    updateNotificationBadges();
                                                }
                                            }
                                        });
                                    });
                            }
                        }
                    });
                }, error => {
                    console.error("Error setting up group notifications:", error);
                    logToConsole("Error setting up group notifications: " + error.message);
                });
        }

        // Helper function to get the other user's ID from chat ID
        function getOtherUserId(chatId) {
            const userIds = chatId.split('_');
            return userIds[0] === currentUser.uid ? userIds[1] : userIds[0];
        }

        // Update notification badges
        function updateNotificationBadges() {
            // Update desktop badges
            const chatsBadge = document.getElementById('chatsNotificationBadge');
            const groupsBadge = document.getElementById('groupsNotificationBadge');
            
            if (chatsBadge) {
                if (notificationCounts.chats > 0) {
                    chatsBadge.textContent = notificationCounts.chats;
                    chatsBadge.classList.remove('hidden');
                } else {
                    chatsBadge.classList.add('hidden');
                }
            }
            
            if (groupsBadge) {
                if (notificationCounts.groups > 0) {
                    groupsBadge.textContent = notificationCounts.groups;
                    groupsBadge.classList.remove('hidden');
                } else {
                    groupsBadge.classList.add('hidden');
                }
            }
            
            // Update mobile badges
            const chatsBadgeMobile = document.getElementById('chatsNotificationBadgeMobile');
            const groupsBadgeMobile = document.getElementById('groupsNotificationBadgeMobile');
            
            if (chatsBadgeMobile) {
                if (notificationCounts.chats > 0) {
                    chatsBadgeMobile.textContent = notificationCounts.chats;
                    chatsBadgeMobile.classList.remove('hidden');
                } else {
                    chatsBadgeMobile.classList.add('hidden');
                }
            }
            
            if (groupsBadgeMobile) {
                if (notificationCounts.groups > 0) {
                    groupsBadgeMobile.textContent = notificationCounts.groups;
                    groupsBadgeMobile.classList.remove('hidden');
                } else {
                    groupsBadgeMobile.classList.add('hidden');
                }
            }
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
    <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('sw.js')
        .then(function(registration) {
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        })
        .catch(function(error) {
          console.log('ServiceWorker registration failed: ', error);
        });
    });
  }
</script>
</body>
</html>
